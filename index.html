<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>R2 Parallel Upload</title>
<style>
body { font-family: sans-serif; background:#0f172a; color:white; padding:30px }
.box { border:2px dashed #3b82f6; padding:40px; text-align:center }
progress { width:100%; height:20px }
</style>
</head>
<body>

<h2>Upload file lớn lên R2 (4 luồng song song)</h2>

<div class="box">
<input type="file" id="file"><br><br>
<button onclick="startUpload()">Upload</button>
</div>

<br>
<progress id="prog" value="0" max="100"></progress>
<div id="status"></div>

<script>
const WORKER_URL = "https://upfile4.trinhhoan00365.workers.dev";
const CHUNK_SIZE = 5 * 1024 * 1024;
const CONCURRENCY = 4;

async function startUpload() {
  const file = document.getElementById("file").files[0];
  if (!file) return alert("Chọn file");

  const init = await fetch(WORKER_URL + "/upload/init", {
    method: "POST",
    body: JSON.stringify({
      fileName: file.name,
      contentType: file.type
    })
  }).then(r => r.json());

  const totalParts = Math.ceil(file.size / CHUNK_SIZE);
  let uploadedBytes = 0;
  const parts = new Array(totalParts);

  let nextPart = 1;

  async function worker() {
    while (true) {
      const partNumber = nextPart++;
      if (partNumber > totalParts) break;

      const start = (partNumber - 1) * CHUNK_SIZE;
      const chunk = file.slice(start, start + CHUNK_SIZE);

      const res = await fetch(${WORKER_URL}/upload/part?uploadId=${init.uploadId}&key=${init.key}&partNumber=${partNumber}, {
        method: "POST",
        body: chunk
      }).then(r => r.json());

      parts[partNumber - 1] = { partNumber, etag: res.etag };

      uploadedBytes += chunk.size;
      updateProgress(uploadedBytes, file.size);
    }
  }

  const workers = [];
  for (let i = 0; i < CONCURRENCY; i++) workers.push(worker());
  await Promise.all(workers);

  await fetch(WORKER_URL + "/upload/complete", {
    method: "POST",
    body: JSON.stringify({
      uploadId: init.uploadId,
      key: init.key,
      parts
    })
  });

  document.getElementById("status").innerText = "✅ Upload thành công!";
}

function updateProgress(done, total) {
  const percent = Math.floor(done / total * 100);
  document.getElementById("prog").value = percent;
  document.getElementById("status").innerText = percent + "%";
}
</script>

</body>
</html>
