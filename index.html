<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>R2 Chunk Upload</title>
<style>
body{background:#0b1220;color:#fff;font-family:sans-serif}
.box{max-width:700px;margin:40px auto;background:#111c33;padding:20px;border-radius:10px}
.progress{height:12px;background:#333;border-radius:6px;overflow:hidden;margin-top:10px}
.bar{height:100%;width:0;background:#22c55e}
table{width:100%;margin-top:15px}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="user" placeholder="user"><br><br>
  <input id="pass" type="password" placeholder="pass"><br><br>
  <button onclick="login()">Login</button>
</div>

<div class="box" id="app" style="display:none">
  <h2>Chunk Upload R2</h2>

  <input type="file" id="file">
  <button onclick="upload()">Upload</button>

  <div class="progress"><div class="bar" id="bar"></div></div>

  <table id="files"></table>
</div>

<script>
const WORKER = "https://upfile4.trinhhoan00365.workers.dev";
let TOKEN = "ok";

function login(){
  fetch(WORKER+"/api/login",{method:"POST",body:JSON.stringify({user:user.value,pass:pass.value})})
  .then(r=>r.json()).then(d=>{
    if(d.ok){
      loginBox.style.display="none";
      app.style.display="block";
      loadFiles();
    } else alert("Sai");
  });
}

async function upload(){
  const f = file.files[0];
  if(!f) return alert("Ch·ªçn file");

  const chunkSize = 5 * 1024 * 1024;
  const totalParts = Math.ceil(f.size / chunkSize);
  const uploadId = crypto.randomUUID();

  for(let i=0;i<totalParts;i++){
    const chunk = f.slice(i*chunkSize,(i+1)*chunkSize);

    await fetch(WORKER+"/api/upload-chunk",{
      method:"POST",
      headers:{
        "Authorization":"ok",
        "X-Upload-Id":uploadId,
        "X-Part":i
      },
      body:chunk
    });

    const percent = Math.floor(((i+1)/totalParts)*100);
    bar.style.width = percent+"%";
  }

  await fetch(WORKER+"/api/complete",{
    method:"POST",
    headers:{Authorization:"ok"},
    body:JSON.stringify({uploadId,fileName:f.name,totalParts})
  });

  bar.style.width="0%";
  alert("Upload xong!");
  loadFiles();
}

function loadFiles(){
  fetch(WORKER+"/api/files",{headers:{Authorization:"ok"}})
  .then(r=>r.json()).then(list=>{
    files.innerHTML="<tr><th>File</th><th>Size(MB)</th></tr>";
    list.forEach(f=>{
      files.innerHTML+=`<tr><td>${f.key}</td><td>${(f.size/1024/1024).toFixed(2)}</td></tr>`;
    });
  });
}
</script>
</body>
</html>
