<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>R2 Manager</title>
<style>
body{margin:0;background:#0b1220;font-family:sans-serif;color:#fff}
.box{max-width:900px;margin:40px auto;background:#111c33;padding:20px;border-radius:10px}
input,button{padding:8px;border-radius:5px;border:none}
button{background:#2563eb;color:#fff;cursor:pointer}
table{width:100%;margin-top:15px;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #333}
.hidden{display:none}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="user" placeholder="User"><br><br>
  <input id="pass" type="password" placeholder="Password"><br><br>
  <button onclick="login()">Login</button>
</div>

<div class="box hidden" id="app">
  <h2>R2 Manager</h2>

  <input type="file" id="file">
  <button onclick="upload()">Upload</button>

  <br><br>

  <input id="folderName" placeholder="Tên thư mục">
  <button onclick="createFolder()">Tạo thư mục</button>

  <table>
    <thead><tr><th>File</th><th>Size</th><th>Action</th></tr></thead>
    <tbody id="files"></tbody>
  </table>
</div>

<script>
const WORKER = "https://upfile4.trinhhoan00365.workers.dev";
let TOKEN = "";

function auth() {
  return { "Authorization": TOKEN };
}

async function login() {
  const r = await fetch(WORKER + "/api/login", {
    method:"POST",
    body:JSON.stringify({user:user.value,pass:pass.value})
  });
  const d = await r.json();
  if(d.ok){
    TOKEN="ok";
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    loadFiles();
  } else alert("Sai tài khoản");
}

async function upload() {
  const f = file.files[0];
  if(!f) return alert("Chọn file");

  const r = await fetch(`${WORKER}/api/upload-url?name=${encodeURIComponent(f.name)}`, {headers:auth()});
  const d = await r.json();

  await fetch(d.uploadUrl,{method:"PUT",body:f});

  alert("Upload xong");
  loadFiles();
}

async function loadFiles() {
  const r = await fetch(WORKER+"/api/files",{headers:auth()});
  const list = await r.json();
  const tb = document.getElementById("files");
  tb.innerHTML="";
  list.forEach(f=>{
    tb.innerHTML += `<tr>
      <td>${f.key}</td>
      <td>${(f.size/1024/1024).toFixed(2)} MB</td>
      <td><button onclick="del('${f.key}')">Xóa</button></td>
    </tr>`;
  });
}

async function del(key) {
  if(!confirm("Xóa?")) return;
  await fetch(WORKER+"/api/delete",{
    method:"POST",
    headers:auth(),
    body:JSON.stringify({key})
  });
  loadFiles();
}

async function createFolder() {
  const name = folderName.value;
  if(!name) return;

  await fetch(WORKER+"/api/folder",{
    method:"POST",
    headers:auth(),
    body:JSON.stringify({name})
  });

  folderName.value="";
  loadFiles();
}
</script>

</body>
</html>
