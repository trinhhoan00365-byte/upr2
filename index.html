<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>R2 Multi Upload</title>
<style>
body { font-family: sans-serif; background:#0f172a; color:white; padding:20px }
.box { border:2px dashed #3b82f6; padding:30px; text-align:center; margin-bottom:20px }
.file-item { margin:10px 0; }
progress { width:100%; height:16px }
</style>
</head>
<body>

<h2>Upload nhiều file lên R2 (2 file song song)</h2>

<div class="box">
<input type="file" id="files" multiple>
<br><br>
<button onclick="startMultiUpload()">Upload</button>
</div>

<div id="list"></div>

<script>
const WORKER_URL = "https://upfile4.trinhhoan00365.workers.dev";
const CHUNK_SIZE = 10 * 1024 * 1024;
const PART_CONCURRENCY = 4;
const FILE_CONCURRENCY = 2;

async function startMultiUpload() {
  const files = [...document.getElementById("files").files];
  if (!files.length) return alert("Chọn file");

  document.getElementById("list").innerHTML = "";

  const queue = files.slice();

  async function runNext() {
    if (!queue.length) return;
    const file = queue.shift();
    await uploadSingleFile(file);
    await runNext();
  }

  const workers = [];
  for (let i = 0; i < FILE_CONCURRENCY; i++) {
    workers.push(runNext());
  }

  await Promise.all(workers);
}

async function uploadSingleFile(file) {
  const id = Math.random().toString(36).slice(2);

  const div = document.createElement("div");
  div.className = "file-item";
  div.innerHTML = `
    <b>${file.name}</b>
    <progress id="p-${id}" value="0" max="100"></progress>
    <div id="s-${id}">Khởi tạo...</div>
  `;
  document.getElementById("list").appendChild(div);

  const statusEl = document.getElementById(`s-${id}`);
  const progEl = document.getElementById(`p-${id}`);

  const init = await fetch(WORKER_URL + "/upload/init", {
    method: "POST",
    body: JSON.stringify({
      fileName: file.name,
      contentType: file.type
    })
  }).then(r => r.json());

  const totalParts = Math.ceil(file.size / CHUNK_SIZE);
  const parts = new Array(totalParts);

  let completed = 0;
  let nextPart = 1;

  function updateProgress() {
    const percent = Math.floor((completed / totalParts) * 100);
    progEl.value = percent;
    statusEl.innerText = percent + "%";
  }

  async function partWorker() {
    while (true) {
      if (nextPart > totalParts) break;
      const partNumber = nextPart++;

      const start = (partNumber - 1) * CHUNK_SIZE;
      const chunk = file.slice(start, start + CHUNK_SIZE);

      const res = await fetch(
        `${WORKER_URL}/upload/part?uploadId=${init.uploadId}&key=${init.key}&partNumber=${partNumber}`,
        { method: "POST", body: chunk }
      ).then(r => r.json());

      parts[partNumber - 1] = { partNumber, etag: res.etag };

      completed++;
      updateProgress();
    }
  }

  const partWorkers = [];
  for (let i = 0; i < PART_CONCURRENCY; i++) {
    partWorkers.push(partWorker());
  }

  await Promise.all(partWorkers);

  statusEl.innerText = "Đang ghép file...";

  await fetch(WORKER_URL + "/upload/complete", {
    method: "POST",
    body: JSON.stringify({
      uploadId: init.uploadId,
      key: init.key,
      parts
    })
  });

  statusEl.innerText = "✅ Hoàn thành";
}
</script>

</body>
</html>
