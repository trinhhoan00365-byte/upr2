<!DOCTYPE html>
<html>
<body style="background:#111;color:#fff;font-family:sans-serif">

<h2>R2 Multipart Upload</h2>

<input type="file" id="file">
<button onclick="upload()">Upload</button>

<br><br>
<progress id="p" value="0" max="100" style="width:300px"></progress>
<div id="s"></div>

<script>
const API = "https://r2-uploat.trinhhoan00365.workers.dev";
const CHUNK = 5 * 1024 * 1024;

async function upload() {
  const f = document.getElementById("file").files[0];
  if (!f) return alert("Chá»n file");

  const name = Date.now() + "-" + f.name;

  const init = await fetch(API+"?action=init", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ filename: name })
  }).then(r=>r.json());

  let parts = [];
  let part = 1;
  let sent = 0;

  for (let i=0;i<f.size;i+=CHUNK) {
    const blob = f.slice(i, i+CHUNK);

    const r = await fetch(`${API}?action=part&key=${encodeURIComponent(name)}&uploadId=${init.uploadId}&part=${part}`, {
      method:"POST",
      body: blob
    }).then(r=>r.json());

    parts.push({ partNumber: part, etag: r.etag });

    sent += blob.size;
    document.getElementById("p").value = sent/f.size*100;
    part++;
  }

  parts.sort((a,b)=>a.partNumber-b.partNumber);

  const done = await fetch(API+"?action=complete", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      key: name,
      uploadId: init.uploadId,
      parts: parts
    })
  }).then(r=>r.text());

  document.getElementById("s").innerText = done;
}
</script>

</body>
</html>
