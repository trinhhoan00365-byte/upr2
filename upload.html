<!DOCTYPE html>
<html>
<body style="background:#111;color:#fff;font-family:sans-serif">

<h2>R2 Multipart Upload</h2>

<input type="file" id="file">
<button onclick="upload()">Upload</button>

<br><br>
<progress id="p" value="0" max="100" style="width:300px"></progress>
<div id="s"></div>

  <script>
const API = "https://r2-uploat.trinhhoan00365.workers.dev";
const CHUNK = 5 * 1024 * 1024;

async function upload() {
  const f = document.getElementById("file").files[0];
  if (!f) return alert("Chọn file");

  const name = Date.now() + "-" + f.name;

  // INIT
  const init = await fetch(API+"?action=init", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ filename: name })
  }).then(r=>r.json());

  const uploadId = init.uploadId;
  const parts = [];

  let partNumber = 1;
  let sent = 0;

  for (let i=0; i<f.size; i+=CHUNK) {
    const blob = f.slice(i, i+CHUNK);

    const res = await fetch(
      `${API}?action=part&key=${encodeURIComponent(name)}&uploadId=${uploadId}&part=${partNumber}`,
      { method:"POST", body: blob }
    );

    if (!res.ok) {
      throw new Error("Upload part failed: " + partNumber);
    }

    const data = await res.json();

    if (!data.etag) {
      throw new Error("Missing etag at part " + partNumber);
    }

    parts.push({
      partNumber: partNumber,
      etag: data.etag
    });

    sent += blob.size;
    document.getElementById("p").value = sent / f.size * 100;

    partNumber++;
  }

  // sort lại chắc chắn
  parts.sort((a,b)=>a.partNumber-b.partNumber);

  // COMPLETE
  const completeRes = await fetch(API+"?action=complete", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      key: name,
      uploadId: uploadId,
      parts: parts
    })
  });

  const txt = await completeRes.text();
  document.getElementById("s").innerText = txt;
}
</script>


</body>
</html>

