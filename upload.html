<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>R2 Multipart Uploader</title>
<style>
body{background:#0d1117;color:#fff;font-family:sans-serif}
.box{max-width:500px;margin:60px auto;padding:25px;background:#161b22;border-radius:12px}
button{padding:10px 15px;background:#238636;color:#fff;border:none;border-radius:6px;cursor:pointer}
progress{width:100%;height:20px}
.file{margin-bottom:10px}
</style>
</head>
<body>

<div class="box">
<h2>Upload to R2 (Multipart)</h2>

<input type="file" id="file"><br><br>
<button onclick="startUpload()">Upload</button>

<br><br>
<progress id="progress" value="0" max="100"></progress>
<div id="status"></div>
</div>

<script>
const API = "https://r2-uploat.trinhhoan00365.workers.dev";
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB

async function startUpload(){
  const file = document.getElementById("file").files[0];
  if(!file) return alert("Chọn file");

  const filename = Date.now()+"-"+file.name;
  document.getElementById("status").innerText = "Khởi tạo upload...";

  const init = await fetch(API+"?action=init",{
    method:"POST",
    body:JSON.stringify({filename})
  }).then(r=>r.json());

  const parts = [];
  let uploaded = 0;
  let partNumber = 1;

  for(let start=0; start<file.size; start+=CHUNK_SIZE){
    const chunk = file.slice(start,start+CHUNK_SIZE);

    document.getElementById("status").innerText =
      `Uploading part ${partNumber} / ${Math.ceil(file.size/CHUNK_SIZE)}`;

    const res = await fetch(
      `${API}?action=part&key=${filename}&uploadId=${init.uploadId}&part=${partNumber}`,
      {method:"POST",body:chunk}
    ).then(r=>r.json());

    parts.push({partNumber,etag:res.etag});
    uploaded += chunk.size;
    partNumber++;

    document.getElementById("progress").value = uploaded/file.size*100;
  }

  document.getElementById("status").innerText = "Hoàn tất...";

  await fetch(API+"?action=complete",{
    method:"POST",
    body:JSON.stringify({
      key:filename,
      uploadId:init.uploadId,
      parts
    })
  });

  document.getElementById("status").innerHTML =
    "✅ Upload thành công:<br>"+filename;
}
</script>

</body>
</html>
